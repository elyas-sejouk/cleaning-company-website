---
// src/components/ContactForm.astro
import { services } from '../data/services.js';
---

<div id="devis" class="bg-soapy-green border-3 border-soapy-black p-8 md:p-10 rounded-3xl shadow-retro relative overflow-hidden">
  
  <div class="absolute -top-10 -right-10 w-40 h-40 bg-soapy-yellow rounded-full border-3 border-soapy-black -z-0"></div>

  <div class="relative z-10">
    
    <div id="form-header" class="mb-8">
      <h2 class="font-retro text-3xl md:text-4xl mb-2">Demander un Devis Sur-Mesure âš¡ï¸</h2>
      <p class="font-bold text-lg">Remplissez ce formulaire pour un prix exact sous 24h.</p>
    </div>

    <div id="success-message" class="hidden text-center py-12">
      <div class="text-6xl mb-4">ğŸ‰</div>
      <h3 class="font-retro text-3xl mb-4">Bien reÃ§u !</h3>
      <p class="font-bold text-lg">On analyse votre demande et on vous envoie le devis trÃ¨s vite.</p>
      <button id="reset-btn" class="mt-8 bg-white text-soapy-black font-bold px-6 py-2 rounded-full border-3 border-soapy-black hover:bg-soapy-orange transition-colors">
        Nouvelle demande
      </button>
    </div>

    <form 
      id="contact-form"
      action="https://formspree.io/f/mwvljvry" 
      method="POST" 
      class="space-y-6"
    >
      
      <div class="grid md:grid-cols-2 gap-4">
        <div class="flex flex-col">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">Nom complet</label>
          <input type="text" name="nom" required class="w-full p-3 rounded-lg border-3 border-soapy-black focus:outline-none focus:shadow-retro-hover transition-all" placeholder="Jean Dupont" />
        </div>
        <div class="flex flex-col">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">Email</label>
          <input type="email" name="email" required class="w-full p-3 rounded-lg border-3 border-soapy-black focus:outline-none focus:shadow-retro-hover transition-all" placeholder="jean.dupont@email.com" />
        </div>
        <div class="flex flex-col">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">TÃ©lÃ©phone</label>
          <input type="tel" name="telephone" required class="w-full p-3 rounded-lg border-3 border-soapy-black focus:outline-none focus:shadow-retro-hover transition-all" placeholder="06 00..." />
        </div>
        <div class="flex flex-col">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">Ville d'intervention</label>
          <input type="text" name="ville" required class="w-full p-3 rounded-lg border-3 border-soapy-black focus:outline-none focus:shadow-retro-hover transition-all" placeholder="ex: Narbonne, BÃ©ziers..." />
        </div>
      </div>

      <hr class="border-soapy-black border-dashed border-t-2 opacity-50" />

      <div class="grid md:grid-cols-2 gap-4">
        
        <div class="flex flex-col md:col-span-2">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">Type de prestation</label>
          <select name="service" class="w-full p-3 rounded-lg border-3 border-soapy-black bg-white focus:outline-none focus:shadow-retro-hover transition-all cursor-pointer">
            <option value="" disabled selected>-- Choisissez le service --</option>
            {services.map((service) => (
              <option value={service.title}>{service.icon} {service.title}</option>
            ))}
            <option value="Autre">ğŸ¤” Autre / SpÃ©cifique</option>
          </select>
        </div>

        <div class="flex flex-col">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">Type de local</label>
          <select name="type_local" class="w-full p-3 rounded-lg border-3 border-soapy-black bg-white focus:outline-none focus:shadow-retro-hover transition-all">
            <option>Appartement</option>
            <option>Maison</option>
            <option>Local Commercial / Bureau</option>
            <option>Immeuble entier</option>
            <option>ExtÃ©rieur / Jardin</option>
          </select>
        </div>

        <div class="flex flex-col">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">Surface (mÂ²)</label>
          <input type="number" name="surface" placeholder="ex: 80" class="w-full p-3 rounded-lg border-3 border-soapy-black focus:outline-none focus:shadow-retro-hover transition-all" />
        </div>

        <div class="flex flex-col">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">Ã‰tat actuel</label>
          <select name="etat_lieux" class="w-full p-3 rounded-lg border-3 border-soapy-black bg-white focus:outline-none focus:shadow-retro-hover transition-all font-bold">
            <option value="Standard" class="text-gray-900">âœ¨ Standard (Entretien)</option>
            <option value="Sale" class="text-gray-900">ğŸ’¨ Sale (Besoin d'un bon coup)</option>
            <option value="Tres_Sale" class="text-gray-900">ğŸ’© TrÃ¨s Sale / Insalubre</option>
            <option value="Chantier" class="text-gray-900">ğŸš§ Fin de Chantier (PoussiÃ¨re)</option>
            <option value="Sinistre" class="text-gray-900">â›ˆï¸ AprÃ¨s Sinistre / Inondation</option>
          </select>
        </div>

        <div class="flex flex-col">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">FrÃ©quence</label>
          <select name="frequence" class="w-full p-3 rounded-lg border-3 border-soapy-black bg-white focus:outline-none focus:shadow-retro-hover transition-all">
            <option value="Ponctuel">Une seule fois (One Shot)</option>
            <option value="Hebdo">RÃ©gulier (Hebdomadaire)</option>
            <option value="Mensuel">RÃ©gulier (Mensuel)</option>
            <option value="Saisonnier">Saisonnier (DÃ©but/Fin saison)</option>
          </select>
        </div>
      </div>

      <div class="bg-white/50 p-4 rounded-xl border-2 border-soapy-black border-dashed">
        <label class="font-bold mb-3 block text-sm uppercase tracking-wide">Options souhaitÃ©es</label>
        <div class="grid grid-cols-2 gap-2 text-sm font-bold">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" name="opt_eco" class="w-5 h-5 accent-soapy-orange border-2 border-black" />
            Produits Ã‰cologiques ğŸŒ¿
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" name="opt_linge" class="w-5 h-5 accent-soapy-orange border-2 border-black" />
            Gestion Linge ğŸ§º
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" name="opt_materiel" class="w-5 h-5 accent-soapy-orange border-2 border-black" />
            Location MatÃ©riel ğŸ§¹
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" name="opt_urgence" class="w-5 h-5 accent-red-500 border-2 border-black" />
            <span class="text-red-600">URGENCE / 24H ğŸš¨</span>
          </label>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="flex flex-col">
          <label class="font-bold mb-1 text-sm uppercase tracking-wide">Date souhaitÃ©e</label>
          <input type="date" name="date" class="w-full p-3 rounded-lg border-3 border-soapy-black focus:outline-none focus:shadow-retro-hover transition-all" />
        </div>
        <div class="flex flex-col md:col-span-2">
            <label class="font-bold mb-1 text-sm uppercase tracking-wide">PrÃ©cisions (AccÃ¨s, Ã‰tages, Codes...)</label>
            <textarea name="message" rows="2" class="w-full p-3 rounded-lg border-3 border-soapy-black focus:outline-none focus:shadow-retro-hover transition-all" placeholder="ex: 4Ã¨me sans ascenseur, clÃ© chez le voisin..."></textarea>
        </div>
      </div>

      <button type="submit" class="w-full bg-soapy-orange text-soapy-black font-bold text-xl py-4 rounded-lg border-3 border-soapy-black shadow-retro hover:translate-y-[2px] hover:translate-x-[2px] hover:shadow-retro-hover transition-all mt-4">
        Obtenir mon Devis
      </button>

    </form>
    
    <p id="error-message" class="hidden text-red-600 font-bold mt-4 text-center">Oups ! Une erreur est survenue.</p>

  </div>
</div>

<script>
  const form = document.getElementById('contact-form');
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');
  const formHeader = document.getElementById('form-header');
  const resetBtn = document.getElementById('reset-btn');

  form?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(form as HTMLFormElement); // Assure-toi que TypeScript ne bloque pas ici
    try {
      const response = await fetch(form.getAttribute('action') as string, {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
      });
      if (response.ok) {
        form.classList.add('hidden');
        formHeader?.classList.add('hidden');
        errorMessage?.classList.add('hidden');
        successMessage?.classList.remove('hidden');
        (form as HTMLFormElement).reset();
      } else { throw new Error('Erreur'); }
    } catch (error) { errorMessage?.classList.remove('hidden'); }
  });

  resetBtn?.addEventListener('click', () => {
    successMessage?.classList.add('hidden');
    form?.classList.remove('hidden');
    formHeader?.classList.remove('hidden');
  });
</script>